{% extends "base.html" %}

{% block title %}Travel Planner - Your Trips{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">My Trips</h1>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTripModal">
                <i class="bi bi-plus-circle"></i> New Trip
            </button>
        </div>

        <!-- Trips List -->
        <div id="tripsList">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading trips...</span>
                </div>
                <p class="text-muted mt-2">Loading your trips...</p>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createTripModal">
                        Create New Trip
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                        Refresh Trips
                    </button>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Getting Started</h6>
            </div>
            <div class="card-body small">
                <p>Welcome to Travel Planner! Here you can:</p>
                <ul class="mb-0">
                    <li>Create and manage your trips</li>
                    <li>Add days to your itinerary</li>
                    <li>Schedule activities for each day</li>
                    <li>Organize everything chronologically</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Create Trip Modal -->
<div class="modal fade" id="createTripModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Trip</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createTripForm">
                <div class="modal-body">
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="tripName" name="name" placeholder="Trip Name" required>
                        <label for="tripName">Trip Name</label>
                    </div>
                    
                    <div class="form-floating mb-3">
                        <textarea class="form-control" id="tripDescription" name="description" placeholder="Description" style="height: 100px"></textarea>
                        <label for="tripDescription">Description (Optional)</label>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="startDate" name="start_date">
                                <label for="startDate">Start Date (Optional)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                <input type="date" class="form-control" id="endDate" name="end_date">
                                <label for="endDate">End Date (Optional)</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Trip</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Trip management functionality
document.addEventListener('DOMContentLoaded', function() {
    loadTrips();
    setupCreateTripForm();
});

async function loadTrips() {
    const tripsList = document.getElementById('tripsList');
    
    try {
        const response = await TravelPlanner.get('/trips');
        const trips = response.data;
        
        if (trips.length === 0) {
            tripsList.innerHTML = `
                <div class="text-center py-5">
                    <div class="mb-3">
                        <svg class="text-muted" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                    </div>
                    <h5 class="text-muted">No trips yet</h5>
                    <p class="text-muted">Create your first trip to get started!</p>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTripModal">
                        Create Your First Trip
                    </button>
                </div>
            `;
            return;
        }
        
        tripsList.innerHTML = trips.map(trip => `
            <div class="card trip-card fade-in">
                <div class="card-body">
                    <div class="trip-header">
                        <div>
                            <h5 class="trip-title">${escapeHtml(trip.name)}</h5>
                            <div class="trip-dates text-muted">
                                ${trip.start_date || trip.end_date ? TravelPlanner.formatDateRange(trip.start_date, trip.end_date) : 'Dates not set'}
                            </div>
                        </div>
                        <div class="trip-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewTrip(${trip.id})">
                                View Details
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editTrip(${trip.id})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTrip(${trip.id}, '${escapeHtml(trip.name)}')">
                                Delete
                            </button>
                        </div>
                    </div>
                    ${trip.description ? `<p class="text-muted mt-2 mb-0">${escapeHtml(trip.description)}</p>` : ''}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Failed to load trips:', error);
        TravelPlanner.showError('Failed to load trips. Please try again.');
        tripsList.innerHTML = `
            <div class="text-center py-5">
                <div class="text-danger mb-3">
                    <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                    </svg>
                </div>
                <h5 class="text-danger">Failed to load trips</h5>
                <p class="text-muted">Please check your connection and try again.</p>
                <button class="btn btn-primary" onclick="loadTrips()">Retry</button>
            </div>
        `;
    }
}

function setupCreateTripForm() {
    const form = document.getElementById('createTripForm');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
            name: formData.get('name'),
            description: formData.get('description') || null,
            start_date: formData.get('start_date') || null,
            end_date: formData.get('end_date') || null
        };
        
        // Validate form
        const validation = TravelPlanner.validateForm(form);
        if (!validation.isValid) {
            return;
        }
        
        const submitBtn = form.querySelector('button[type="submit"]');
        TravelPlanner.showLoading(submitBtn);
        
        try {
            await TravelPlanner.post('/trips', data);
            TravelPlanner.showSuccess('Trip created successfully!');
            
            // Close modal and reload trips
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTripModal'));
            modal.hide();
            form.reset();
            loadTrips();
            
        } catch (error) {
            console.error('Failed to create trip:', error);
            TravelPlanner.showError('Failed to create trip. Please try again.');
        } finally {
            TravelPlanner.hideLoading(submitBtn);
        }
    });
}

function viewTrip(tripId) {
    // TODO: Implement trip detail view (Task 9)
    TravelPlanner.showSuccess(`Trip detail view for trip ${tripId} coming soon!`);
}

function editTrip(tripId) {
    // TODO: Implement trip editing (Task 9)
    TravelPlanner.showSuccess(`Trip editing for trip ${tripId} coming soon!`);
}

async function deleteTrip(tripId, tripName) {
    if (!confirm(`Are you sure you want to delete "${tripName}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        await TravelPlanner.delete(`/trips/${tripId}`);
        TravelPlanner.showSuccess('Trip deleted successfully!');
        loadTrips();
    } catch (error) {
        console.error('Failed to delete trip:', error);
        TravelPlanner.showError('Failed to delete trip. Please try again.');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}